var FollowCamera=pc.createScript("followCamera");FollowCamera.attributes.add("target",{type:"entity",title:"Target",description:"The Entity to follow"}),FollowCamera.attributes.add("distance",{type:"number",default:4,title:"Distance",description:"How far from the Entity should the follower be"}),FollowCamera.prototype.initialize=function(){this.pos=new pc.Vec3,this.offset=new pc.Vec3},FollowCamera.prototype.postUpdate=function(t){this.target&&(this.offset.set(.75,1,.75).scale(this.distance),this.pos.copy(this.target.getPosition()).add(this.offset),this.pos.lerp(this.entity.getPosition(),this.pos,.1),this.entity.setPosition(this.pos))};var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1,min:.05,max:.5,precision:2,description:"Controls the movement speed"}),Movement.prototype.initialize=function(){this.force=new pc.Vec3,this.spawnPos=this.entity.getPosition().clone()},Movement.prototype.update=function(e){if(this.entity.getPosition().y<-1)return void this.teleport(this.spawnPos);const t=this.app.keyboard;let s=0,i=0;if((t.isPressed(pc.KEY_LEFT)||t.isPressed(pc.KEY_A))&&(s=-this.speed),(t.isPressed(pc.KEY_RIGHT)||t.isPressed(pc.KEY_D))&&(s+=this.speed),(t.isPressed(pc.KEY_UP)||t.isPressed(pc.KEY_W))&&(i=-this.speed),(t.isPressed(pc.KEY_DOWN)||t.isPressed(pc.KEY_S))&&(i+=this.speed),this.force.set(s,0,i),this.force.lengthSq()>0){this.force.normalize().scale(this.speed);const e=.25*-Math.PI,t=Math.cos(e),s=Math.sin(e),i=this.force.x*t-this.force.z*s,o=this.force.z*t+this.force.x*s;this.force.set(i,0,o)}this.entity.rigidbody.applyImpulse(this.force)},Movement.prototype.teleport=function(e){this.entity.rigidbody.teleport(e),this.spawnPos.copy(e),this.entity.rigidbody.linearVelocity=pc.Vec3.ZERO,this.entity.rigidbody.angularVelocity=pc.Vec3.ZERO};var Teleporter=pc.createScript("teleporter");Teleporter.attributes.add("target",{type:"entity",title:"Target Entity",description:"The target entity where we are going to teleport"}),Teleporter.prototype.initialize=function(){const onTriggerEnter=t=>{if(t.script.movement){const e=this.target.getPosition().clone();e.y+=.5,t.script.movement.teleport(e)}};this.entity.collision.on("triggerenter",onTriggerEnter),this.on("destroy",(()=>{this.entity.collision.off("triggerenter",onTriggerEnter)}))};function FxaaEffect(e){pc.PostEffect.call(this,e);var o=["uniform sampler2D uColorBuffer;","uniform vec2 uResolution;","","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","","void main()","{","    vec3 rgbNW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * uResolution ).xyz;","    vec3 rgbNE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * uResolution ).xyz;","    vec3 rgbSW = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * uResolution ).xyz;","    vec3 rgbSE = texture2D( uColorBuffer, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * uResolution ).xyz;","    vec4 rgbaM  = texture2D( uColorBuffer,  gl_FragCoord.xy  * uResolution );","    vec3 rgbM  = rgbaM.xyz;","    float opacity  = rgbaM.w;","","    vec3 luma = vec3( 0.299, 0.587, 0.114 );","","    float lumaNW = dot( rgbNW, luma );","    float lumaNE = dot( rgbNE, luma );","    float lumaSW = dot( rgbSW, luma );","    float lumaSE = dot( rgbSE, luma );","    float lumaM  = dot( rgbM,  luma );","    float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","    float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","","    vec2 dir;","    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","","    float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","","    float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","    dir = min( vec2( FXAA_SPAN_MAX, FXAA_SPAN_MAX), max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * uResolution;","","    vec3 rgbA = 0.5 * (","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","","    vec3 rgbB = rgbA * 0.5 + 0.25 * (","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * -0.5 ).xyz +","        texture2D( uColorBuffer, gl_FragCoord.xy  * uResolution + dir * 0.5 ).xyz );","","    float lumaB = dot( rgbB, luma );","","    if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )","    {","        gl_FragColor = vec4( rgbA, opacity );","    }","    else","    {","        gl_FragColor = vec4( rgbB, opacity );","    }","}"].join("\n");this.fxaaShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"FxaaShader",{aPosition:pc.SEMANTIC_POSITION}),this.resolution=new Float32Array(2)}FxaaEffect.prototype=Object.create(pc.PostEffect.prototype),FxaaEffect.prototype.constructor=FxaaEffect,Object.assign(FxaaEffect.prototype,{render:function(e,o,a){var r=this.device.scope;this.resolution[0]=1/e.width,this.resolution[1]=1/e.height,r.resolve("uResolution").setValue(this.resolution),r.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(o,this.fxaaShader,a)}});var Fxaa=pc.createScript("fxaa");Fxaa.prototype.initialize=function(){this.effect=new FxaaEffect(this.app.graphicsDevice);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(o){o?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};var SAMPLE_COUNT=15;function computeGaussian(e,t){return 1/Math.sqrt(2*Math.PI*t)*Math.exp(-e*e/(2*t*t))}function calculateBlurValues(e,t,o,r,s){e[0]=computeGaussian(0,s),t[0]=0,t[1]=0;var i,a,l=e[0];for(i=0,a=Math.floor(SAMPLE_COUNT/2);i<a;i++){var u=computeGaussian(i+1,s);e[2*i]=u,e[2*i+1]=u,l+=2*u;var h=2*i+1.5;t[4*i]=o*h,t[4*i+1]=r*h,t[4*i+2]=-o*h,t[4*i+3]=-r*h}for(i=0,a=e.length;i<a;i++)e[i]/=l}function BloomEffect(e){pc.PostEffect.call(this,e);var t={aPosition:pc.SEMANTIC_POSITION},o=["varying vec2 vUv0;","","uniform sampler2D uBaseTexture;","uniform float uBloomThreshold;","","void main(void)","{","    vec4 color = texture2D(uBaseTexture, vUv0);","","    gl_FragColor = clamp((color - uBloomThreshold) / (1.0 - uBloomThreshold), 0.0, 1.0);","}"].join("\n"),r=[`#define SAMPLE_COUNT ${SAMPLE_COUNT}`,"","varying vec2 vUv0;","","uniform sampler2D uBloomTexture;",`uniform vec2 uBlurOffsets[${SAMPLE_COUNT}];`,`uniform float uBlurWeights[${SAMPLE_COUNT}];`,"","void main(void)","{","    vec4 color = vec4(0.0);","    for (int i = 0; i < SAMPLE_COUNT; i++)","    {","        color += texture2D(uBloomTexture, vUv0 + uBlurOffsets[i]) * uBlurWeights[i];","    }","","    gl_FragColor = color;","}"].join("\n"),s=["varying vec2 vUv0;","","uniform float uBloomEffectIntensity;","uniform sampler2D uBaseTexture;","uniform sampler2D uBloomTexture;","","void main(void)","{","    vec4 bloom = texture2D(uBloomTexture, vUv0) * uBloomEffectIntensity;","    vec4 base = texture2D(uBaseTexture, vUv0);","","    base *= (1.0 - clamp(bloom, 0.0, 1.0));","","    gl_FragColor = base + bloom;","}"].join("\n");this.extractShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"BloomExtractShader",t),this.blurShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,r,"BloomBlurShader",t),this.combineShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,s,"BloomCombineShader",t),this.targets=[],this.bloomThreshold=.25,this.blurAmount=4,this.bloomIntensity=1.25,this.sampleWeights=new Float32Array(SAMPLE_COUNT),this.sampleOffsets=new Float32Array(2*SAMPLE_COUNT)}BloomEffect.prototype=Object.create(pc.PostEffect.prototype),BloomEffect.prototype.constructor=BloomEffect,BloomEffect.prototype._destroy=function(){var e;if(this.targets)for(e=0;e<this.targets.length;e++)this.targets[e].destroyTextureBuffers(),this.targets[e].destroy();this.targets.length=0},BloomEffect.prototype._resize=function(e){var t,o=e.colorBuffer.width,r=e.colorBuffer.height;if(o!==this.width||r!==this.height)for(this.width=o,this.height=r,this._destroy(),t=0;t<2;t++){var s=new pc.Texture(this.device,{name:`Bloom Texture${t}`,format:pc.PIXELFORMAT_RGBA8,width:o>>1,height:r>>1,mipmaps:!1});s.minFilter=pc.FILTER_LINEAR,s.magFilter=pc.FILTER_LINEAR,s.addressU=pc.ADDRESS_CLAMP_TO_EDGE,s.addressV=pc.ADDRESS_CLAMP_TO_EDGE,s.name=`pe-bloom-${t}`;var i=new pc.RenderTarget({name:`Bloom Render Target ${t}`,colorBuffer:s,depth:!1});this.targets.push(i)}},Object.assign(BloomEffect.prototype,{render:function(e,t,o){this._resize(e);var r=this.device.scope;r.resolve("uBloomThreshold").setValue(this.bloomThreshold),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(this.targets[0],this.extractShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,1/this.targets[1].width,0,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),this.drawQuad(this.targets[1],this.blurShader),calculateBlurValues(this.sampleWeights,this.sampleOffsets,0,1/this.targets[0].height,this.blurAmount),r.resolve("uBlurWeights[0]").setValue(this.sampleWeights),r.resolve("uBlurOffsets[0]").setValue(this.sampleOffsets),r.resolve("uBloomTexture").setValue(this.targets[1].colorBuffer),this.drawQuad(this.targets[0],this.blurShader),r.resolve("uBloomEffectIntensity").setValue(this.bloomIntensity),r.resolve("uBloomTexture").setValue(this.targets[0].colorBuffer),r.resolve("uBaseTexture").setValue(e.colorBuffer),this.drawQuad(t,this.combineShader,o)}});var Bloom=pc.createScript("bloom");Bloom.attributes.add("bloomIntensity",{type:"number",default:1,min:0,title:"Intensity"}),Bloom.attributes.add("bloomThreshold",{type:"number",default:.25,min:0,max:1,title:"Threshold"}),Bloom.attributes.add("blurAmount",{type:"number",default:4,min:1,title:"Blur amount"}),Bloom.prototype.initialize=function(){this.effect=new BloomEffect(this.app.graphicsDevice),this.effect.bloomThreshold=this.bloomThreshold,this.effect.blurAmount=this.blurAmount,this.effect.bloomIntensity=this.bloomIntensity;var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("attr",(function(e,t){this.effect[e]=t}),this),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect),this.effect._destroy()}))};function BlendEffect(e){pc.PostEffect.call(this,e);var t=["uniform float uMixRatio;","uniform sampler2D uColorBuffer;","uniform sampler2D uBlendMap;","","varying vec2 vUv0;","","void main(void)","{","    vec4 texel1 = texture2D(uColorBuffer, vUv0);","    vec4 texel2 = texture2D(uBlendMap, vUv0);","    gl_FragColor = mix(texel1, texel2, uMixRatio);","}"].join("\n");this.shader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,t,"BlendShader",{aPosition:pc.SEMANTIC_POSITION}),this.mixRatio=.5,this.blendMap=new pc.Texture(e),this.blendMap.name="pe-blend"}BlendEffect.prototype=Object.create(pc.PostEffect.prototype),BlendEffect.prototype.constructor=BlendEffect,Object.assign(BlendEffect.prototype,{render:function(e,t,i){var a=this.device.scope;a.resolve("uMixRatio").setValue(this.mixRatio),a.resolve("uColorBuffer").setValue(e.colorBuffer),a.resolve("uBlendMap").setValue(this.blendMap),this.drawQuad(t,this.shader,i)}});var Blend=pc.createScript("blend");Blend.attributes.add("mixRatio",{type:"number",default:.5,min:0,max:1,title:"Mix Ratio"}),Blend.attributes.add("blendMap",{type:"asset",assetType:"texture",title:"Blend Map"}),Blend.prototype.initialize=function(){this.effect=new BlendEffect(this.app.graphicsDevice),this.effect.mixRatio=this.mixRatio,this.blendMap&&(this.effect.blendMap=this.blendMap.resource);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)})),this.on("attr:mixRatio",(function(e){this.effect.mixRatio=e}),this),this.on("attr:blendMap",(function(e){this.effect.blendMap=e?e.resource:null}),this)};function BokehEffect(e){pc.PostEffect.call(this,e),this.needsDepthBuffer=!0;var r=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uColorBuffer;","","uniform float uMaxBlur;","uniform float uAperture;","","uniform float uFocus;","uniform float uAspect;","","void main()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float factor = ((getLinearScreenDepth(vUv0) * -1.0) - uFocus) / camera_params.y;","","    vec2 dofblur = vec2 ( clamp( factor * uAperture, -uMaxBlur, uMaxBlur ) );","","    vec2 dofblur9 = dofblur * 0.9;","    vec2 dofblur7 = dofblur * 0.7;","    vec2 dofblur4 = dofblur * 0.4;","","    vec4 col;","","    col  = texture2D( uColorBuffer, vUv0 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.15,  0.37 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.37,  0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.37, -0.15 ) * aspectCorrect ) * dofblur9 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.15, -0.37 ) * aspectCorrect ) * dofblur9 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.40,  0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur7 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur7 );","","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,  -0.4  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29,  0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.4,   0.0  ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2( -0.29, -0.29 ) * aspectCorrect ) * dofblur4 );","    col += texture2D( uColorBuffer, vUv0 + ( vec2(  0.0,   0.4  ) * aspectCorrect ) * dofblur4 );","","    gl_FragColor = col / 41.0;","    gl_FragColor.a = 1.0;","}"].join("\n");this.shader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,r,"BokehShader",{aPosition:pc.SEMANTIC_POSITION}),this.maxBlur=.02,this.aperture=1,this.focus=1}BokehEffect.prototype=Object.create(pc.PostEffect.prototype),BokehEffect.prototype.constructor=BokehEffect,Object.assign(BokehEffect.prototype,{render:function(e,r,t){var o=this.device,u=o.scope;u.resolve("uMaxBlur").setValue(this.maxBlur),u.resolve("uAperture").setValue(this.aperture),u.resolve("uFocus").setValue(this.focus),u.resolve("uAspect").setValue(o.width/o.height),u.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(r,this.shader,t)}});var Bokeh=pc.createScript("bokeh");Bokeh.attributes.add("maxBlur",{type:"number",default:.02,min:0,max:1,title:"Max Blur"}),Bokeh.attributes.add("aperture",{type:"number",default:1,min:0,max:1,title:"Aperture"}),Bokeh.attributes.add("focus",{type:"number",default:1,title:"Focus"}),Bokeh.prototype.initialize=function(){this.effect=new BokehEffect(this.app.graphicsDevice),this.effect.maxBlur=this.maxBlur,this.effect.aperture=this.aperture,this.effect.focus=this.focus,this.on("attr",(function(e,r){this.effect[e]=r}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(r){r?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};function BrightnessContrastEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uBrightness;","uniform float uContrast;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","    gl_FragColor.rgb += uBrightness;","","    if (uContrast > 0.0) {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - uContrast) + 0.5;","    } else {","        gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + uContrast) + 0.5;","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"BrightnessContrastShader",{aPosition:pc.SEMANTIC_POSITION}),this.brightness=0,this.contrast=0}BrightnessContrastEffect.prototype=Object.create(pc.PostEffect.prototype),BrightnessContrastEffect.prototype.constructor=BrightnessContrastEffect,Object.assign(BrightnessContrastEffect.prototype,{render:function(t,e,s){var r=this.device.scope;r.resolve("uBrightness").setValue(this.brightness),r.resolve("uContrast").setValue(this.contrast),r.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,s)}});var BrightnessContrast=pc.createScript("brightnessContrast");BrightnessContrast.attributes.add("brightness",{type:"number",default:0,min:-1,max:1,title:"Brightness"}),BrightnessContrast.attributes.add("contrast",{type:"number",default:0,min:-1,max:1,title:"Contrast"}),BrightnessContrast.prototype.initialize=function(){this.effect=new BrightnessContrastEffect(this.app.graphicsDevice),this.effect.brightness=this.brightness,this.effect.contrast=this.contrast,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function EdgeDetectEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","varying vec2 vUv0;","uniform vec2 uResolution;","uniform float uIntensity;","uniform vec4 uColor;","","mat3 G[2];","","const mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","const mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","","void main(void)","{","    mat3 I;","    float cnv[2];","    vec3 sample;","","    G[0] = g0;","    G[1] = g1;","","    for (float i = 0.0; i < 3.0; i++)","    {","        for (float j = 0.0; j < 3.0; j++)","        {","            sample = texture2D(uColorBuffer, vUv0 + uResolution * vec2(i - 1.0, j - 1.0)).rgb;","            I[int(i)][int(j)] = length(sample);","         }","    }","","    for (int i=0; i<2; i++)","    {","        float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","        cnv[i] = dp3 * dp3; ","    }","","    gl_FragColor = uIntensity * uColor * vec4(sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"EdgeDetectShader",{aPosition:pc.SEMANTIC_POSITION}),this.resolution=new Float32Array(2),this.intensity=1,this.color=new pc.Color(1,1,1,1)}EdgeDetectEffect.prototype=Object.create(pc.PostEffect.prototype),EdgeDetectEffect.prototype.constructor=EdgeDetectEffect,Object.assign(EdgeDetectEffect.prototype,{render:function(t,e,o){var i=this.device.scope;this.resolution[0]=1/t.width,this.resolution[1]=1/t.height,i.resolve("uResolution").setValue(this.resolution),i.resolve("uColorBuffer").setValue(t.colorBuffer),i.resolve("uColor").setValue(this.color.data),i.resolve("uIntensity").setValue(this.intensity),this.drawQuad(e,this.shader,o)}});var EdgeDetect=pc.createScript("edgeDetect");EdgeDetect.attributes.add("intensity",{type:"number",default:1,min:0,max:2,title:"Intensity"}),EdgeDetect.attributes.add("color",{type:"rgba",default:[.5,.5,.5,1],title:"Color"}),EdgeDetect.prototype.initialize=function(){this.effect=new EdgeDetectEffect(this.app.graphicsDevice),this.effect.intensity=this.intensity,this.effect.color=this.color,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function HorizontalTiltShiftEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uH;","uniform float uR;","","varying vec2 vUv0;","","void main() {","    vec4 sum = vec4( 0.0 );","    float hh = uH * abs( uR - vUv0.x );","","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 4.0 * hh, vUv0.y ) ) * 0.051;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 3.0 * hh, vUv0.y ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 2.0 * hh, vUv0.y ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x - 1.0 * hh, vUv0.y ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y ) ) * 0.1633;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 1.0 * hh, vUv0.y ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 2.0 * hh, vUv0.y ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 3.0 * hh, vUv0.y ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x + 4.0 * hh, vUv0.y ) ) * 0.051;","","    gl_FragColor = sum;","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"HorizontalTiltShiftShader",{aPosition:pc.SEMANTIC_POSITION}),this.focus=.35}HorizontalTiltShiftEffect.prototype=Object.create(pc.PostEffect.prototype),HorizontalTiltShiftEffect.prototype.constructor=HorizontalTiltShiftEffect,Object.assign(HorizontalTiltShiftEffect.prototype,{render:function(t,e,o){var f=this.device.scope;f.resolve("uH").setValue(1/t.width),f.resolve("uR").setValue(this.focus),f.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,o)}});var HorizontalTiltShift=pc.createScript("horizontalTiltShift");HorizontalTiltShift.attributes.add("focus",{type:"number",default:.35,min:0,max:1,title:"Focus"}),HorizontalTiltShift.prototype.initialize=function(){this.effect=new HorizontalTiltShiftEffect(this.app.graphicsDevice),this.effect.focus=this.focus,this.on("attr:focus",(function(t){this.effect.focus=t}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function HueSaturationEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uHue;","uniform float uSaturation;","","varying vec2 vUv0;","","void main() {","    gl_FragColor = texture2D( uColorBuffer, vUv0 );","","    float angle = uHue * 3.14159265;","    float s = sin(angle), c = cos(angle);","    vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","    float len = length(gl_FragColor.rgb);","    gl_FragColor.rgb = vec3(","        dot(gl_FragColor.rgb, weights.xyz),","        dot(gl_FragColor.rgb, weights.zxy),","        dot(gl_FragColor.rgb, weights.yzx)","    );","","    float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","    if (uSaturation > 0.0) {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - uSaturation));","    } else {","        gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-uSaturation);","    }","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"HueSaturationShader",{aPosition:pc.SEMANTIC_POSITION}),this.hue=0,this.saturation=0}HueSaturationEffect.prototype=Object.create(pc.PostEffect.prototype),HueSaturationEffect.prototype.constructor=HueSaturationEffect,Object.assign(HueSaturationEffect.prototype,{render:function(t,e,r){var a=this.device.scope;a.resolve("uHue").setValue(this.hue),a.resolve("uSaturation").setValue(this.saturation),a.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,r)}});var HueSaturation=pc.createScript("hueSaturation");HueSaturation.attributes.add("hue",{type:"number",default:0,min:-1,max:1,title:"Hue"}),HueSaturation.attributes.add("saturation",{type:"number",default:0,min:-1,max:1,title:"Saturation"}),HueSaturation.prototype.initialize=function(){this.effect=new HueSaturationEffect(this.app.graphicsDevice),this.effect.hue=this.hue,this.effect.saturation=this.saturation,this.on("attr",(function(t,e){this.effect[t]=e}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function LuminosityEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec3 luma = vec3(0.299, 0.587, 0.114);","    float v = dot(texel.xyz, luma);","    gl_FragColor = vec4(v, v, v, texel.w);","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"LuminosityShader",{aPosition:pc.SEMANTIC_POSITION})}LuminosityEffect.prototype=Object.create(pc.PostEffect.prototype),LuminosityEffect.prototype.constructor=LuminosityEffect,Object.assign(LuminosityEffect.prototype,{render:function(t,e,o){this.device.scope.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,o)}});var Luminosity=pc.createScript("luminosity");Luminosity.prototype.initialize=function(){this.effect=new LuminosityEffect(this.app.graphicsDevice);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function OutlineEffect(t,e){pc.PostEffect.call(this,t);var i=[`#define THICKNESS ${e?e.toFixed(0):1}`,"uniform float uWidth;","uniform float uHeight;","uniform vec4 uOutlineCol;","uniform sampler2D uColorBuffer;","uniform sampler2D uOutlineTex;","","varying vec2 vUv0;","","void main(void)","{","    vec4 texel1 = texture2D(uColorBuffer, vUv0);","    float sample0 = texture2D(uOutlineTex, vUv0).a;","    float outline = 0.0;","    if (sample0==0.0)","    {","        for (int x=-THICKNESS;x<=THICKNESS;x++)","        {","            for (int y=-THICKNESS;y<=THICKNESS;y++)","            {    ","                float tex=texture2DLodEXT(uOutlineTex, vUv0 + vec2(float(x)/uWidth, float(y)/uHeight), 0.0).a;","                if (tex>0.0)","                {","                    outline=1.0;","                }","            }","        } ","    }","    gl_FragColor = mix(texel1, uOutlineCol, outline * uOutlineCol.a);","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,i,"OutlineShader",{aPosition:pc.SEMANTIC_POSITION}),this.color=new pc.Color(1,1,1,1),this.texture=new pc.Texture(t),this.texture.name="pe-outline",this._colorData=new Float32Array(4)}OutlineEffect.prototype=Object.create(pc.PostEffect.prototype),OutlineEffect.prototype.constructor=OutlineEffect,Object.assign(OutlineEffect.prototype,{render:function(t,e,i){var o=this.device.scope;this._colorData[0]=this.color.r,this._colorData[1]=this.color.g,this._colorData[2]=this.color.b,this._colorData[3]=this.color.a,o.resolve("uWidth").setValue(t.width),o.resolve("uHeight").setValue(t.height),o.resolve("uOutlineCol").setValue(this._colorData),o.resolve("uColorBuffer").setValue(t.colorBuffer),o.resolve("uOutlineTex").setValue(this.texture),this.drawQuad(e,this.shader,i)}});var Outline=pc.createScript("outline");Outline.attributes.add("color",{type:"rgb",default:[.5,.5,.5],title:"Color"}),Outline.attributes.add("thickness",{type:"number",default:1,min:1,max:10,precision:0,title:"Thickness",description:"Note: Changing the thickness requires reloading the effect."}),Outline.attributes.add("texture",{type:"asset",assetType:"texture",title:"Texture"}),Outline.prototype.initialize=function(){this.effect=new OutlineEffect(this.app.graphicsDevice,this.thickness),this.effect.color=this.color,this.effect.texture=this.texture.resource;var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)})),this.on("attr:color",(function(t){this.effect.color=t}),this),this.on("attr:texture",(function(t){this.effect.texture=t?t.resource:null}),this)};function SepiaEffect(t){pc.PostEffect.call(this,t);var e=["uniform float uAmount;","uniform sampler2D uColorBuffer;","","varying vec2 vUv0;","","void main() {","    vec4 color = texture2D(uColorBuffer, vUv0);","    vec3 c = color.rgb;","","    color.r = dot(c, vec3(1.0 - 0.607 * uAmount, 0.769 * uAmount, 0.189 * uAmount));","    color.g = dot(c, vec3(0.349 * uAmount, 1.0 - 0.314 * uAmount, 0.168 * uAmount));","    color.b = dot(c, vec3(0.272 * uAmount, 0.534 * uAmount, 1.0 - 0.869 * uAmount));","","    gl_FragColor = vec4(min(vec3(1.0), color.rgb), color.a);","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"SepiaShader",{aPosition:pc.SEMANTIC_POSITION}),this.amount=1}SepiaEffect.prototype=Object.create(pc.PostEffect.prototype),SepiaEffect.prototype.constructor=SepiaEffect,Object.assign(SepiaEffect.prototype,{render:function(t,e,o){var c=this.device.scope;c.resolve("uAmount").setValue(this.amount),c.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,o)}});var Sepia=pc.createScript("sepia");Sepia.attributes.add("amount",{type:"number",default:1,min:0,max:1,title:"Amount"}),Sepia.prototype.initialize=function(){this.effect=new SepiaEffect(this.app.graphicsDevice),this.effect.amount=this.amount,this.on("attr:amount",(function(t){this.effect.amount=t}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function SSAOEffect(e,t){pc.PostEffect.call(this,e),this.ssaoScript=t,this.needsDepthBuffer=!0;var i=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","//uniform sampler2D uColorBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","#define saturate(x) clamp(x,0.0,1.0)","","// Largely based on 'Dominant Light Shadowing'","// 'Lighting Technology of The Last of Us Part II' by Hawar Doghramachi, Naughty Dog, LLC","","const float kSSCTLog2LodRate = 3.0;","","highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {","    // this essentially returns (p * vec4(v, 1.0)).w, but we make some assumptions","    // this assumes a perspective projection","    return -v.z;","    // this assumes a perspective or ortho projection","    // return p[2][3] * v.z + p[3][3];","}","","highp float getViewSpaceZFromW(const mat4 p, const float w) {","    // this assumes a perspective projection","    return -w;","    // this assumes a perspective or ortho projection","   // return (w - p[3][3]) / p[2][3];","}","","","const float kLog2LodRate = 3.0;","","vec2 sq(const vec2 a) {","    return a * a;","}","","uniform float uInvFarPlane;","","vec2 pack(highp float depth) {","// we need 16-bits of precision","    highp float z = clamp(depth * uInvFarPlane, 0.0, 1.0);","    highp float t = floor(256.0 * z);","    mediump float hi = t * (1.0 / 256.0);   // we only need 8-bits of precision","    mediump float lo = (256.0 * z) - t;     // we only need 8-bits of precision","    return vec2(hi, lo);","}","","// random number between 0 and 1, using interleaved gradient noise","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","// returns the frag coord in the GL convention with (0, 0) at the bottom-left","highp vec2 getFragCoord() {","    return gl_FragCoord.xy;","}","","highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {","    return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);","}","","highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {","    return normalize(cross(dpdx, dpdy));","}","","// Compute normals using derivatives, which essentially results in half-resolution normals","// this creates arifacts around geometry edges.","// Note: when using the spirv optimizer, this results in much slower execution time because","//       this whole expression is inlined in the AO loop below.","highp vec3 computeViewSpaceNormal(const highp vec3 position) {","    return faceNormal(dFdx(position), dFdy(position));","}","","// Compute normals directly from the depth texture, resulting in full resolution normals","// Note: This is actually as cheap as using derivatives because the texture fetches","//       are essentially equivalent to textureGather (which we don't have on ES3.0),","//       and this is executed just once.","highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {","    highp vec2 uvdx = uv + vec2(uResolution.z, 0.0);","    highp vec2 uvdy = uv + vec2(0.0, uResolution.w);","    highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));","    highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));","    highp vec3 dpdx = px - position;","    highp vec3 dpdy = py - position;","    return faceNormal(dpdx, dpdy);","}","","// Ambient Occlusion, largely inspired from:","// 'The Alchemy Screen-Space Ambient Obscurance Algorithm' by Morgan McGuire","// 'Scalable Ambient Obscurance' by Morgan McGuire, Michael Mara and David Luebke","","uniform vec2 uSampleCount;","uniform float uSpiralTurns;","","#define PI (3.14159)","","vec3 tapLocation(float i, const float noise) {","    float offset = ((2.0 * PI) * 2.4) * noise;","    float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(cos(angle), sin(angle), radius * radius);","}","","highp vec2 startPosition(const float noise) {","    float angle = ((2.0 * PI) * 2.4) * noise;","    return vec2(cos(angle), sin(angle));","}","","uniform vec2 uAngleIncCosSin;","","highp mat2 tapAngleStep() {","    highp vec2 t = uAngleIncCosSin;","    return mat2(t.x, t.y, -t.y, t.x);","}","","vec3 tapLocationFast(float i, vec2 p, const float noise) {","    float radius = (i + noise + 0.5) * uSampleCount.y;","    return vec3(p, radius * radius);","}","","uniform float uMaxLevel;","uniform float uInvRadiusSquared;","uniform float uMinHorizonAngleSineSquared;","uniform float uBias;","uniform float uPeak2;","","void computeAmbientOcclusionSAO(inout float occlusion, float i, float ssDiskRadius,","        const highp vec2 uv,  const highp vec3 origin, const vec3 normal,","        const vec2 tapPosition, const float noise) {","","    vec3 tap = tapLocationFast(i, tapPosition, noise);","","    float ssRadius = max(1.0, tap.z * ssDiskRadius);","","    vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uResolution.zw;","","    float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));","    highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);","    highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);","","    // now we have the sample, compute AO","    vec3 v = p - origin;        // sample vector","    float vv = dot(v, v);       // squared distance","    float vn = dot(v, normal);  // distance * cos(v, normal)","","    // discard samples that are outside of the radius, preventing distant geometry to","    // cast shadows -- there are many functions that work and choosing one is an artistic","    // decision.","    float w = max(0.0, 1.0 - vv * uInvRadiusSquared);","    w = w*w;","","    // discard samples that are too close to the horizon to reduce shadows cast by geometry","    // not sufficiently tessellated. The goal is to discard samples that form an angle 'beta'","    // smaller than 'epsilon' with the horizon. We already have dot(v,n) which is equal to the","    // sin(beta) * |v|. So the test simplifies to vn^2 < vv * sin(epsilon)^2.","    w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);","","    occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);","}","","uniform float uProjectionScaleRadius;","uniform float uIntensity;","","float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {","    float noise = random(getFragCoord());","    highp vec2 tapPosition = startPosition(noise);","    highp mat2 angleStep = tapAngleStep();","","    // Choose the screen-space sample radius","    // proportional to the projected area of the sphere","    float ssDiskRadius = -(uProjectionScaleRadius / origin.z);","","    float occlusion = 0.0;","    for (float i = 0.0; i < uSampleCount.x; i += 1.0) {","        computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);","        tapPosition = angleStep * tapPosition;","    }","    return sqrt(occlusion * uIntensity);","}","","uniform float uPower;","","void main() {","    highp vec2 uv = vUv0; //variable_vertex.xy; // interpolated to pixel center","","    highp float depth = -getLinearScreenDepth(vUv0);","    highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);","    vec3 normal = computeViewSpaceNormal(origin, uv);","","    float occlusion = 0.0;","","    if (uIntensity > 0.0) {","        occlusion = scalableAmbientObscurance(uv, origin, normal);","    }","","    // occlusion to visibility","    float aoVisibility = pow(saturate(1.0 - occlusion), uPower);","","    vec4 inCol = vec4(1.0, 1.0, 1.0, 1.0); //texture2D( uColorBuffer,  uv );","","    gl_FragColor.r = aoVisibility; //postProcess.color.rgb = vec3(aoVisibility, pack(origin.z));","}","","void main_old()","{","    vec2 aspectCorrect = vec2( 1.0, uAspect );","","    float depth = getLinearScreenDepth(vUv0);","    gl_FragColor.r = fract(floor(depth*256.0*256.0)),fract(floor(depth*256.0)),fract(depth);","}"].join("\n"),o=[pc.shaderChunks.screenDepthPS,"","varying vec2 vUv0;","","uniform sampler2D uSSAOBuffer;","uniform vec4 uResolution;","","uniform float uAspect;","","uniform int uBilatSampleCount;","uniform float uFarPlaneOverEdgeDistance;","uniform float uBrightness;","","float random(const highp vec2 w) {","    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);","    return fract(m.z * fract(dot(w, m.xy)));","}","","float bilateralWeight(in float depth, in float sampleDepth) {","    float diff = (sampleDepth - depth) * uFarPlaneOverEdgeDistance;","    return max(0.0, 1.0 - diff * diff);","}","","void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {","    // ambient occlusion sample","    float ssao = texture2D( uSSAOBuffer, position ).r;","    float tdepth = -getLinearScreenDepth( position );","","    // bilateral sample","    float bilateral = bilateralWeight(depth, tdepth);","    bilateral *= weight;","    sum += ssao * bilateral;","    totalWeight += bilateral;","}","","void main() {","    highp vec2 uv = vUv0; // variable_vertex.xy; // interpolated at pixel's center","","    // we handle the center pixel separately because it doesn't participate in bilateral filtering","    float depth = -getLinearScreenDepth(vUv0); // unpack(data.gb);","    float totalWeight = 0.0; // float(uBilatSampleCount*2+1)*float(uBilatSampleCount*2+1);","    float ssao = texture2D( uSSAOBuffer, vUv0 ).r;","    float sum = ssao * totalWeight;","","    for (int x = -uBilatSampleCount; x <= uBilatSampleCount; x++) {","       for (int y = -uBilatSampleCount; y < uBilatSampleCount; y++) {","           float weight = 1.0;","           vec2 offset = vec2(x,y)*uResolution.zw;","           tap(sum, totalWeight, weight, depth, uv + offset);","       }","    }","","    float ao = sum / totalWeight;","","    // simple dithering helps a lot (assumes 8 bits target)","    // this is most useful with high quality/large blurs","    // ao += ((random(gl_FragCoord.xy) - 0.5) / 255.0);","","    ao = mix(ao, 1.0, uBrightness);","    gl_FragColor.a = ao;","}"].join("\n"),a=["varying vec2 vUv0;","uniform sampler2D uColorBuffer;","uniform sampler2D uSSAOBuffer;","","void main(void)","{","    vec4 inCol = texture2D( uColorBuffer, vUv0 );","    float ssao = texture2D( uSSAOBuffer, vUv0 ).a;","    gl_FragColor.rgb = inCol.rgb * ssao;","    gl_FragColor.a = inCol.a;","}"].join("\n"),s={aPosition:pc.SEMANTIC_POSITION};this.ssaoShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,i,"SsaoShader",s),this.blurShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,o,"SsaoBlurShader",s),this.outputShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,a,"SsaoOutputShader",s),this.radius=4,this.brightness=0,this.samples=20,this.downscale=1}SSAOEffect.prototype=Object.create(pc.PostEffect.prototype),SSAOEffect.prototype.constructor=SSAOEffect,SSAOEffect.prototype._destroy=function(){this.target&&(this.target.destroyTextureBuffers(),this.target.destroy(),this.target=null),this.blurTarget&&(this.blurTarget.destroyTextureBuffers(),this.blurTarget.destroy(),this.blurTarget=null)},SSAOEffect.prototype._resize=function(e){var t=Math.ceil(e.colorBuffer.width/this.downscale),i=Math.ceil(e.colorBuffer.height/this.downscale);if(t!==this.width||i!==this.height){this.width=t,this.height=i,this._destroy();var o=new pc.Texture(this.device,{format:pc.PIXELFORMAT_RGBA8,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,width:this.width,height:this.height,mipmaps:!1});o.name="SSAO Result",this.target=new pc.RenderTarget({name:"SSAO Result Render Target",colorBuffer:o,depth:!1});var a=new pc.Texture(this.device,{format:pc.PIXELFORMAT_RGBA8,minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,width:this.width,height:this.height,mipmaps:!1});a.name="SSAO Blur",this.blurTarget=new pc.RenderTarget({name:"SSAO Blur Render Target",colorBuffer:a,depth:!1})}},Object.assign(SSAOEffect.prototype,{render:function(e,t,i){this._resize(e);var o=this.device,a=o.scope,s=this.samples,r=1/(s-.5)*10*2*3.141,n=this.radius,l=.1*n,u=2*l*3.141*.125,c=.5*o.height,h=this.ssaoScript.entity.camera.farClip;a.resolve("uAspect").setValue(this.width/this.height),a.resolve("uResolution").setValue([this.width,this.height,1/this.width,1/this.height]),a.resolve("uBrightness").setValue(this.brightness),a.resolve("uInvFarPlane").setValue(1/h),a.resolve("uSampleCount").setValue([s,1/s]),a.resolve("uSpiralTurns").setValue(10),a.resolve("uAngleIncCosSin").setValue([Math.cos(r),Math.sin(r)]),a.resolve("uMaxLevel").setValue(0),a.resolve("uInvRadiusSquared").setValue(1/(n*n)),a.resolve("uMinHorizonAngleSineSquared").setValue(0),a.resolve("uBias").setValue(.001),a.resolve("uPeak2").setValue(l*l),a.resolve("uIntensity").setValue(u),a.resolve("uPower").setValue(1),a.resolve("uProjectionScaleRadius").setValue(c*n),this.drawQuad(this.target,this.ssaoShader,i),a.resolve("uSSAOBuffer").setValue(this.target.colorBuffer),a.resolve("uFarPlaneOverEdgeDistance").setValue(1),a.resolve("uBilatSampleCount").setValue(4),this.drawQuad(this.blurTarget,this.blurShader,i),a.resolve("uSSAOBuffer").setValue(this.blurTarget.colorBuffer),a.resolve("uColorBuffer").setValue(e.colorBuffer),this.drawQuad(t,this.outputShader,i)}});var SSAO=pc.createScript("ssao");SSAO.attributes.add("radius",{type:"number",default:4,min:0,max:20,title:"Radius"}),SSAO.attributes.add("brightness",{type:"number",default:0,min:0,max:1,title:"Brightness"}),SSAO.attributes.add("samples",{type:"number",default:16,min:1,max:256,title:"Samples"}),SSAO.attributes.add("downscale",{type:"number",default:1,min:1,max:4,title:"Downscale"}),SSAO.prototype.initialize=function(){this.effect=new SSAOEffect(this.app.graphicsDevice,this),this.effect.radius=this.radius,this.effect.brightness=this.brightness,this.effect.samples=this.samples,this.effect.downscale=this.downscale,this.on("attr",(function(e,t){this.effect[e]=t}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect),this.effect._destroy()}))};function VerticalTiltShiftEffect(t){pc.PostEffect.call(this,t);var e=["uniform sampler2D uColorBuffer;","uniform float uV;","uniform float uR;","","varying vec2 vUv0;","","void main() {","    vec4 sum = vec4( 0.0 );","    float vv = uV * abs( uR - vUv0.y );","","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 4.0 * vv ) ) * 0.051;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 3.0 * vv ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 2.0 * vv ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y - 1.0 * vv ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y ) ) * 0.1633;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 1.0 * vv ) ) * 0.1531;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 2.0 * vv ) ) * 0.12245;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 3.0 * vv ) ) * 0.0918;","    sum += texture2D( uColorBuffer, vec2( vUv0.x, vUv0.y + 4.0 * vv ) ) * 0.051;","","    gl_FragColor = sum;","}"].join("\n");this.shader=pc.createShaderFromCode(t,pc.PostEffect.quadVertexShader,e,"VerticalTiltShiftShader",{aPosition:pc.SEMANTIC_POSITION}),this.focus=.35}VerticalTiltShiftEffect.prototype=Object.create(pc.PostEffect.prototype),VerticalTiltShiftEffect.prototype.constructor=VerticalTiltShiftEffect,Object.assign(VerticalTiltShiftEffect.prototype,{render:function(t,e,f){var r=this.device.scope;r.resolve("uV").setValue(1/t.height),r.resolve("uR").setValue(this.focus),r.resolve("uColorBuffer").setValue(t.colorBuffer),this.drawQuad(e,this.shader,f)}});var VerticalTiltShift=pc.createScript("verticalTiltShift");VerticalTiltShift.attributes.add("focus",{type:"number",default:.35,min:0,max:1,title:"Focus"}),VerticalTiltShift.prototype.initialize=function(){this.effect=new VerticalTiltShiftEffect(this.app.graphicsDevice),this.effect.focus=this.focus,this.on("attr:focus",(function(t){this.effect.focus=t}),this);var t=this.entity.camera.postEffects;t.addEffect(this.effect),this.on("state",(function(e){e?t.addEffect(this.effect):t.removeEffect(this.effect)})),this.on("destroy",(function(){t.removeEffect(this.effect)}))};function VignetteEffect(e){pc.PostEffect.call(this,e);var t=["uniform sampler2D uColorBuffer;","uniform float uDarkness;","uniform float uOffset;","","varying vec2 vUv0;","","void main() {","    vec4 texel = texture2D(uColorBuffer, vUv0);","    vec2 uv = (vUv0 - vec2(0.5)) * vec2(uOffset);","    gl_FragColor = vec4(mix(texel.rgb, vec3(1.0 - uDarkness), dot(uv, uv)), texel.a);","}"].join("\n");this.vignetteShader=pc.createShaderFromCode(e,pc.PostEffect.quadVertexShader,t,"VignetteShader",{aPosition:pc.SEMANTIC_POSITION}),this.offset=1,this.darkness=1}VignetteEffect.prototype=Object.create(pc.PostEffect.prototype),VignetteEffect.prototype.constructor=VignetteEffect,Object.assign(VignetteEffect.prototype,{render:function(e,t,f){var s=this.device.scope;s.resolve("uColorBuffer").setValue(e.colorBuffer),s.resolve("uOffset").setValue(this.offset),s.resolve("uDarkness").setValue(this.darkness),this.drawQuad(t,this.vignetteShader,f)}});var Vignette=pc.createScript("vignette");Vignette.attributes.add("offset",{type:"number",default:1,min:0,title:"Offset"}),Vignette.attributes.add("darkness",{type:"number",default:1,title:"Darkness"}),Vignette.prototype.initialize=function(){this.effect=new VignetteEffect(this.app.graphicsDevice),this.effect.offset=this.offset,this.effect.darkness=this.darkness,this.on("attr",(function(e,t){this.effect[e]=t}),this);var e=this.entity.camera.postEffects;e.addEffect(this.effect),this.on("state",(function(t){t?e.addEffect(this.effect):e.removeEffect(this.effect)})),this.on("destroy",(function(){e.removeEffect(this.effect)}))};